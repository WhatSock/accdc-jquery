/*
CSS Drag and Drop Module R2.0 for Standalone and Dojo
Copyright 2010-2013 Bryan Garaventa (WhatSock.com)
Part of AccDC, a Cross-Browser JavaScript accessibility API, distributed under the terms of the Open Source Initiative OSI - MIT License
	*/
(function(){(function(a){(function(f){f.fn.drag=function(k,g,j){var i=typeof k=="string"?k:"",h=f.isFunction(k)?k:f.isFunction(g)?g:null;if(i.indexOf("drag")!==0){i="drag"+i}j=(k==h?g:j)||{};if(h){this.bind(i,j,h)}else{this.trigger(i)}return this};var c=f.event,b=c.special,e=b.drag={defaults:{which:1,distance:0,not:"input, textarea, select, button",handle:null,relative:false,drop:true,click:false},datakey:"dragdata",livekey:"livedrag",add:function(i){var h=f.data(this,e.datakey),g=i.data||{};h.related+=1;if(!h.live&&i.selector){h.live=true;c.add(this,"draginit."+e.livekey,e.delegate)}f.each(e.defaults,function(j,k){if(g[j]!==undefined){h[j]=g[j]}})},remove:function(){f.data(this,e.datakey).related-=1},setup:function(){if(f.data(this,e.datakey)){return}var g=f.extend({related:0},e.defaults);f.data(this,e.datakey,g);c.add(this,"touchstart mousedown",e.init,g);if(this.attachEvent){this.attachEvent("ondragstart",e.dontstart)}},teardown:function(){if(f.data(this,e.datakey).related){return}f.removeData(this,e.datakey);c.remove(this,"touchstart mousedown",e.init);c.remove(this,"draginit",e.delegate);e.textselect(true);if(this.detachEvent){this.detachEvent("ondragstart",e.dontstart)}},init:function(l){if(e.touched){return}var g=l.data,k;if(l.which!=0&&g.which>0&&l.which!=g.which){return}if(g.not){var h=$A.query(g.not,l.target.parentNode);for(var j=0;j<h.length;j++){if(l.target==h[j]){return}}}if(g.handle&&!f(l.target).closest(g.handle,l.currentTarget).length){return}e.touched=("ontouchstart" in window)?this:null;g.propagates=1;g.interactions=[e.interaction(this,g)];g.target=l.target;g.pageX=l.pageX;g.pageY=l.pageY;g.dragging=null;k=e.hijack(l,"draginit",g);if(!g.propagates){return}k=e.flatten(k);if(k&&k.length){g.interactions=[];f.each(k,function(){g.interactions.push(e.interaction(this,g))})}g.propagates=g.interactions.length;if(g.drop!==false&&b.drop){b.drop.handler(l,g)}e.textselect(false);if(e.touched){c.add(e.touched,"touchmove touchend",e.handler,g)}else{c.add(document,"mousemove mouseup",e.handler,g)}if(!e.touched||g.live){return false}},interaction:function(j,h){var k=$A.xOffset(j),g=$A.css(j,"position");if(g=="fixed"){k.top=j.offsetTop}else{if(h.relative||g=="relative"){var i=$A.xOffset(j.parentNode);k={top:k.top-i.top,left:k.left-i.left}}}return{drag:j,callback:new e.callback(),droppable:[],offset:k}},handler:function(h){var g=h.data;switch(h.type){case !g.dragging&&"touchmove":h.preventDefault();case !g.dragging&&"mousemove":if(Math.pow(h.pageX-g.pageX,2)+Math.pow(h.pageY-g.pageY,2)<Math.pow(g.distance,2)){break}h.target=g.target;e.hijack(h,"dragstart",g);if(g.propagates){g.dragging=true}case"touchmove":h.preventDefault();case"mousemove":if(g.dragging){e.hijack(h,"drag",g);if(g.propagates){if(g.drop!==false&&b.drop){b.drop.handler(h,g)}break}h.type="mouseup"}case"touchend":case"mouseup":if(e.touched){c.remove(e.touched,"touchmove touchend",e.handler)}else{c.remove(document,"mousemove mouseup",e.handler)}if(g.dragging){if(g.drop!==false&&b.drop){b.drop.handler(h,g)}e.hijack(h,"dragend",g)}e.textselect(true);if(g.click===false&&g.dragging){a.event.triggered=true;setTimeout(function(){a.event.triggered=false},20);g.dragging=false}e.touched=false;break}},delegate:function(i){var g=[],j,h=f.data(this,"events")||{};f.each(h.live||[],function(k,l){if(l.preType.indexOf("drag")!==0){return}j=f(i.target).closest(l.selector,i.currentTarget)[0];if(!j){return}c.add(j,l.origType+"."+e.livekey,l.origHandler,l.data);if(f.inArray(j,g)<0){g.push(j)}});if(!g.length){return false}return f(g).bind("dragend."+e.livekey,function(){c.remove(this,"."+e.livekey)})},hijack:function(h,o,r,p,k){if(!r){return}var q={event:h.originalEvent,type:h.type},m=o.indexOf("drop")?"drag":"drop",t,l=p||0,j,g,s,n=!isNaN(p)?p:r.interactions.length;h.type=o;h.originalEvent=null;r.results=[];do{if(j=r.interactions[l]){if(o!=="dragend"&&j.cancelled){continue}s=e.properties(h,r,j);j.results=[];f(k||j[m]||r.droppable).each(function(u,i){s.target=i;h.isPropagationStopped=function(){return false};t=i?c.handle.call(i,h,s):null;if(t===false){if(m=="drag"){j.cancelled=true;r.propagates-=1}if(o=="drop"){j[m][u]=null}}else{if(o=="dropinit"){j.droppable.push(e.element(t)||i)}}if(o=="dragstart"){j.proxy=f(e.element(t)||j.drag)[0]}j.results.push(t);delete h.result;if(o!=="dropinit"){return t}});r.results[l]=e.flatten(j.results);if(o=="dropinit"){j.droppable=e.flatten(j.droppable)}if(o=="dragstart"&&!j.cancelled){s.update()}}}while(++l<n);h.type=q.type;h.originalEvent=q.event;return e.flatten(r.results)},properties:function(i,g,h){var j=h.callback;j.drag=h.drag;j.proxy=h.proxy||h.drag;j.startX=g.pageX;j.startY=g.pageY;j.deltaX=i.pageX-g.pageX;j.deltaY=i.pageY-g.pageY;j.originalX=h.offset.left;j.originalY=h.offset.top;j.offsetX=j.originalX+j.deltaX;j.offsetY=j.originalY+j.deltaY;j.drop=e.flatten((h.drop||[]).slice());j.available=e.flatten((h.droppable||[]).slice());return j},element:function(g){if(g&&(g.pL||g.nodeType==1)){return g}},flatten:function(g){return f.map(g,function(h){return h&&h.pL?f.makeArray(h):h&&h.length?e.flatten(h):h})},textselect:function(g){f(document)[g?"unbind":"bind"]("selectstart",e.dontstart);$A.css(document,"MozUserSelect",g?"":"none");document.unselectable=(g?"off":"on")},dontstart:function(){return false},callback:function(){}};e.callback.prototype={update:function(){if(b.drop&&this.available.length){f.each(this.available,function(g){b.drop.locate(this,g)})}}};var d=c.fixHooks.touchstart=c.fixHooks.touchmove=c.fixHooks.touchend=c.fixHooks.touchcancel={props:"clientX clientY pageX pageY screenX screenY".split(" "),filter:function(h,i){if(i){var g=(i.touches&&i.touches[0])||(i.changedTouches&&i.changedTouches[0])||null;if(g){f.each(d.props,function(j,k){h[k]=g[k]})}}return h}};b.draginit=b.dragstart=b.dragend=e})(a);(function(e){var c=e.event,d=c.special.drag,b=d.add,f=d.teardown;d.noBubble=false;d.livekey="livedrag";d.add=function(h){b.apply(this,arguments);var g=e.data(this,d.datakey);if(!g.live&&h.selector){g.live=true;c.add(this,"draginit."+d.livekey,d.delegate)}};d.teardown=function(){f.apply(this,arguments);var g=e.data(this,d.datakey)||{};if(g.live){c.remove(this,"draginit."+d.livekey,d.delegate);g.live=false}};d.delegate=function(i){var g=[],j,h=e.data(this,"events")||{};e.each(h||[],function(l,k){if(l.indexOf("drag")!==0){return}e.each(k||[],function(m,n){j=e(i.target).closest(n.selector,i.currentTarget)[0];if(!j){return}c.add(j,n.origType+"."+d.livekey,n.origHandler||n.handler,n.data);if(e.inArray(j,g)<0){g.push(j)}})});if(!g.length){return false}return e(g).bind("dragend."+d.livekey,function(){c.remove(this,"."+d.livekey)})}})(a);(function(e){e.fn.drop=function(j,f,i){var h=typeof j=="string"?j:"",g=e.isFunction(j)?j:e.isFunction(f)?f:null;if(h.indexOf("drop")!==0){h="drop"+h}i=(j==g?f:i)||{};if(g){this.bind(h,i,g)}else{this.trigger(h)}return this};e.drop=function(f){f=f||{};c.multi=f.multi===true?Infinity:f.multi===false?1:!isNaN(f.multi)?f.multi:c.multi;c.delay=f.delay||c.delay;c.tolerance=e.isFunction(f.tolerance)?f.tolerance:f.tolerance===null?null:c.tolerance;c.mode=f.mode||c.mode||"overlap"};var d=e.event,b=d.special,c=e.event.special.drop={multi:1,delay:20,mode:"overlap",targets:[],datakey:"dropdata",livekey:"livedrop",noBubble:true,add:function(g){var f=e.data(this,c.datakey);f.related+=1;if(!f.live&&g.selector){f.live=true;d.add(this,"dropinit."+c.livekey,c.delegate)}},remove:function(){e.data(this,c.datakey).related-=1},setup:function(){if(e.data(this,c.datakey)){return}var f={related:0,active:[],anyactive:0,winner:0,location:{}};e.data(this,c.datakey,f);c.targets.push(this)},teardown:function(){if((e.data(this,c.datakey)||{}).related){return}e.removeData(this,c.datakey);d.remove(this,"dropinit",c.delegate);var f=this;c.targets=e.grep(c.targets,function(g){return(g!==f)})},handler:function(h,f){var g,i;if(!f){return}switch(h.type){case"mousedown":case"touchstart":i=e(c.targets);if(typeof f.drop=="string"){i=i.filter(f.drop)}i.each(function(){var j=e.data(this,c.datakey);j.active=[];j.anyactive=0;j.winner=0});f.droppable=i;c.delegates=[];b.drag.hijack(h,"dropinit",f);c.delegates=e.unique(b.drag.flatten(c.delegates));break;case"mousemove":case"touchmove":c.event=h;if(!c.timer){c.tolerate(f)}break;case"mouseup":case"touchend":c.timer=clearTimeout(c.timer);if(f.propagates){b.drag.hijack(h,"drop",f);b.drag.hijack(h,"dropend",f);e.each(c.delegates||[],function(){d.remove(this,"."+c.livekey)})}break}},delegate:function(h){var f=[],i,g=e.data(this,"events")||{};e.each(g.live||[],function(j,k){if(k.preType.indexOf("drop")!==0){return}i=e(h.currentTarget).find(k.selector);if(!i.length){return}i.each(function(){d.add(this,k.origType+"."+c.livekey,k.origHandler,k.data);if(e.inArray(this,f)<0){f.push(this)}})});c.delegates.push(f);return f.length?e(f):false},locate:function(k,h){var l=e.data(k,c.datakey),i=$A.xOffset(k),f=$A.xHeight(k),j=$A.xWidth(k);var g={elem:k,width:j,height:f,top:i.top,left:i.left,right:i.left+j,bottom:i.top+f};if(l){l.location=g;l.index=h;l.elem=k}return g},contains:function(f,g){return((g[0]||g.left)>=f.left&&(g[0]||g.right)<=f.right&&(g[1]||g.top)>=f.top&&(g[1]||g.bottom)<=f.bottom)},modes:{intersect:function(g,f,h){return this.contains(h,[g.pageX,g.pageY])?1000000000:this.modes.overlap.apply(this,arguments)},overlap:function(g,f,h){return Math.max(0,Math.min(h.bottom,f.bottom)-Math.max(h.top,f.top))*Math.max(0,Math.min(h.right,f.right)-Math.max(h.left,f.left))},fit:function(g,f,h){return this.contains(h,f)?1:0},middle:function(g,f,h){return this.contains(h,[f.left+f.width*0.5,f.top+f.height*0.5])?1:0}},sort:function(g,f){return(f.winner-g.winner)||(g.index-f.index)},tolerate:function(r){var l,f,o,k,m,n,h,q=0,g,j=r.interactions.length,s=[c.event.pageX,c.event.pageY],p=c.tolerance||c.modes[c.mode];do{if(g=r.interactions[q]){if(!g){return}g.drop=[];m=[];n=g.droppable.length;if(p){o=c.locate(g.proxy)}l=0;do{if(h=g.droppable[l]){k=e.data(h,c.datakey);f=k.location;if(!f){continue}k.winner=p?p.call(c,c.event,o,f):c.contains(f,s)?1:0;m.push(k)}}while(++l<n);m.sort(c.sort);l=0;do{if(k=m[l]){if(k.winner&&g.drop.length<c.multi){if(!k.active[q]&&!k.anyactive){if(b.drag.hijack(c.event,"dropstart",r,q,k.elem)[0]!==false){k.active[q]=1;k.anyactive+=1}else{k.winner=0}}if(k.winner){g.drop.push(k.elem)}}else{if(k.active[q]&&k.anyactive==1){b.drag.hijack(c.event,"dropend",r,q,k.elem);k.active[q]=0;k.anyactive-=1}}}}while(++l<n)}}while(++q<j);if(c.last&&s[0]==c.last.pageX&&s[1]==c.last.pageY){delete c.timer}else{c.timer=setTimeout(function(){c.tolerate(r)},c.delay)}c.last=c.event}};b.dropinit=b.dropstart=b.dropend=c})(a);(function(e){var d=e.event,b=d.special.drop,c=b.add,f=b.teardown;b.noBubble=false;b.livekey="livedrop";b.add=function(h){c.apply(this,arguments);var g=e.data(this,b.datakey);if(!g.live&&h.selector){g.live=true;d.add(this,"dropinit."+b.livekey,b.delegate)}};b.teardown=function(){f.apply(this,arguments);var g=e.data(this,b.datakey)||{};if(g.live){d.remove(this,"dropinit",b.delegate);g.live=false}};b.delegate=function(j,g){var h=[],k,i=e.data(this,"events")||{};e.each(i||[],function(m,l){if(m.indexOf("drop")!==0){return}e.each(l,function(n,o){k=e(j.currentTarget).find(o.selector);if(!k.length){return}k.each(function(){d.add(this,o.origType+"."+b.livekey,o.origHandler||o.handler,o.data);if(e.inArray(this,h)<0){h.push(this)}})})});if(g){d.add(g.drag,"dragend."+b.livekey,function(){e.each(h.concat(this),function(){d.remove(this,"."+b.livekey)})})}return h.length?e(h):false}})(a)})($A.internal);$A.setDragAndDrop=function(c){var f="tmp"+$A.genId(),d=c.ddCSS||{},e=c.cssObj||{},b=c.on||{},a=c.root||document;$A.query(c.setDrag,a,function(g,h){$A.morph(h,{id:f+g,role:c.setName(h),showHiddenBounds:false,showHiddenClose:false,original:h,isDraggable:true,drag:{confineTo:c.confineTo},accDD:{on:true,dragText:c.dragText||"Drag",dropText:c.dropText||"Drop",actionText:c.actionText||"Dragging",dragLinkStyle:d,dropLinkStyle:d,dragClassName:c.dragClassName||"",dropClassName:c.dropClassName||"",dropAnchor:c.dropAnchor||"",duration:c.duration||1000},onDragStart:c.on.dragStart,onDrag:c.on.drag,onDropStart:c.on.dropStart,onDrop:c.on.drop,onDropEnd:c.on.dropEnd,onDragEnd:c.on.dragEnd,dropTarget:c.setDrop,cssObj:e,displayInline:c.displayInline||false,runBefore:function(i){if(c.runBefore){c.runBefore.apply(i,[i])}},runAfter:function(i){if(c.runAfter){c.runAfter.apply(i,[i])}}})})}})();